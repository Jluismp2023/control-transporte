<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transporte de Materiales v48.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primario: #4A90E2;
            --color-secundario: #6c757d;
            --color-fondo: #F8F9FA;
            --color-texto: #343A40;
            --color-borde: #DEE2E6;
            --color-blanco: #FFFFFF;
            --color-error: #dc3545;
            --color-exito: #28a745;
            --color-aviso: #ffc107;
            --sombra-suave: 0 4px 6px rgba(0,0,0,0.08);
        }

        body { 
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; 
            margin: 0; 
            background-color: var(--color-fondo); 
            color: var(--color-texto); 
            display: none;
        }
        .main-container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        #logo { height: 70px; margin-right: 15px; }
        
        .title-container { text-align: center; flex-grow: 1; }
        .title-container h1 { margin: 0; font-size: 1.8em; line-height: 1.2; color: var(--color-primario); }
        .title-container h2 { margin: 5px 0 0 0; font-size: 1.2em; color: var(--color-secundario); font-weight: 400; border: none; }

        h2, h3 { color: var(--color-primario); text-align: center; }
        h2 { border-bottom: 2px solid #eef; padding-bottom: 10px; }
        .card { 
            background: var(--color-blanco); 
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: var(--sombra-suave);
            border: 1px solid var(--color-borde);
            margin-bottom: 30px; 
        }
        .tabs { display: flex; border-bottom: 2px solid var(--color-borde); margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; background-color: #eee; border: 1px solid var(--color-borde); border-bottom: none; border-radius: 8px 8px 0 0; margin-right: 5px; font-weight: bold; }
        .tab-button.active { background-color: var(--color-primario); color: var(--color-blanco); border-color: var(--color-primario); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        form { display: flex; flex-direction: column; gap: 15px; }
        ul { list-style-type: none; padding: 0; max-height: 200px; overflow-y: auto; }
        li { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        li .actions { display: flex; gap: 5px; }
        input, select, textarea { padding: 12px; border: 1px solid var(--color-borde); border-radius: 6px; font-size: 16px; background-color: var(--color-blanco); font-family: inherit; }
        button { padding: 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.3s, opacity 0.3s; }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn-primary { background-color: var(--color-primario); color: var(--color-blanco); }
        .btn-success { background-color: var(--color-exito); color: var(--color-blanco); }
        .btn-secondary { background-color: var(--color-secundario); color: var(--color-blanco); }
        .action-btn, .list-action-btn { font-size: 12px; padding: 5px 10px; }
        .delete-btn { background-color: var(--color-error); color: var(--color-blanco); }
        .edit-btn { background-color: var(--color-aviso); color: black; }
        table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        th, td { border: 1px solid var(--color-borde); padding: 10px; text-align: left; word-break: break-word; }
        th { background-color: #f2f7ff; }
        tfoot td { font-weight: bold; background-color: #f2f7ff; }
        #registrosBody tr:nth-child(even) { background-color: var(--color-fondo); }
        #registrosBody tr:hover { background-color: #E9ECEF; }
        .admin-container { display: flex; gap: 20px; }
        .admin-sidebar { flex: 0 0 200px; display: flex; flex-direction: column; gap: 10px; }
        .admin-sidebar button { width: 100%; text-align: left; padding: 15px; background-color: #eee; color: var(--color-texto); }
        .admin-sidebar button.active { background-color: var(--color-primario); color: var(--color-blanco); }
        .admin-content { flex-grow: 1; }
        .form-buttons { display: flex; gap: 10px; }
        .filter-form { display: flex; gap: 15px; align-items: center; justify-content: center; flex-wrap: wrap; }
        .filter-form label { font-weight: bold; }
        #btnCancelarEdicion { display: none; }
        .print-only { display: none; }
        #signature-section { display: none; }
        
        @media print {
            body { background-color: white; font-size: 9pt; font-family: Arial, Helvetica, sans-serif; display: block !important; }
            @page {
                size: A4 landscape; margin: 1.5cm;
                @bottom-center { content: "Página " counter(page); font-size: 9pt; color: #666; }
            }
            .main-container { margin: 0; padding: 0; }
            .card { box-shadow: none; border: none; padding: 0; margin-bottom: 20px; page-break-inside: avoid; }
            .print-only {
                display: block; text-align: center; font-size: 18pt; font-weight: bold; color: #003366;
                padding-bottom: 10px; margin-bottom: 15px; border-bottom: 2px solid #aed6f1;
            }
            .no-print { display: none; }
            .header-container, .tabs, .tab-content:not(.active), form, .list-action-btn, .card:has(.filter-form) { display: none; }
            .action-cell { display: none; }
            #btnLogout { display: none; }
            .tab-content.active { display: block !important; }
            table { border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #333 !important; padding: 6px; text-align: left; vertical-align: middle; }
            th { background-color: #EAEAEA !important; font-weight: bold; text-align: center; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            tfoot td { background-color: #E0E0E0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; text-align: center; }
            tfoot td:first-child { text-align: right; }
            #signature-section { display: flex; justify-content: center; margin-top: 60px; }
            .signature-box { text-align: center; width: 300px; }
            .signature-box p { margin: 2px 0; }
            .signature-line { margin-bottom: 8px; font-weight: bold; }
        }
    </style>
</head>
<body>

<div class="main-container">
    <div class="header-container">
        <img id="logo" src="logo.png" alt="Logo de la Empresa">
        <div class="title-container">
            <h1>OBRAS EQUIPOS Y CONSTRUCCIONES<br>OBRECO CIA LTDA</h1>
            <h2>TRANSPORTE DE MATERIALES PETREOS</h2>
        </div>
        <button id="btnLogout" class="btn-secondary" style="margin-left: auto;">Cerrar Sesión</button>
    </div>

    <div class="tabs">
        <button class="tab-button active" data-tab="tab-registro">Registro</button>
        <button class="tab-button" data-tab="tab-admin">Administración</button>
        <button class="tab-button" data-tab="tab-summary">Reportes</button>
    </div>

    <div id="tab-registro" class="tab-content active"></div>
    <div id="tab-admin" class="tab-content"></div>
    <div id="tab-summary" class="tab-content"></div>
    <div id="signature-section"></div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, where, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDtDX8xK1m1VxjfRMFsDZXoAH36l8Izyz8",
        authDomain: "control-transporte-c4f61.firebaseapp.com",
        projectId: "control-transporte-c4f61",
        storageBucket: "control-transporte-c4f61.appspot.com",
        messagingSenderId: "447956658904",
        appId: "1:447956658904:web:81e9b40fb55107f93ec5ad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = 'login.html';
        } else {
            document.body.style.display = 'block';
            inicializarApp();
        }
    });

    const cargarContenidoHTML = () => {
        document.getElementById('tab-registro').innerHTML = `<div class="card"><h2 id="formViajeTitulo">🚚 Nuevo Registro de Viaje</h2><form id="transporteForm"><input type="hidden" id="indiceEdicion"><select id="selectNombres" required><option value="">1. Seleccionar Chofer</option></select><select id="selectPlaca" required disabled><option value="">2. Seleccionar Placa</option></select><select id="selectMaterial" required><option value="">3. Seleccionar Material</option></select><input type="number" id="volumen" placeholder="Volumen (se autocompleta)" step="0.01" readonly required><input type="date" id="fecha" required><select id="selectCantera" required><option value="">Seleccionar Cantera</option></select><select id="selectProyecto" required><option value="">Seleccionar Proyecto</option></select><input type="number" id="numViajes" placeholder="# de Viajes" value="1" min="1" required><textarea id="observaciones" placeholder="Observaciones (opcional)" rows="3"></textarea><div class="form-buttons"><button type="submit" id="btnSubmitViaje" class="btn-primary" style="flex-grow: 1;">Agregar Registro</button><button type="button" id="btnCancelarEdicion" class="btn-secondary" style="flex-grow: 1;">Cancelar</button></div></form></div>`;
        
        document.getElementById('tab-admin').innerHTML = `
            <div class="admin-container">
                <div class="admin-sidebar">
                    <button data-section="choferes">👤 Nombres de Choferes</button>
                    <button data-section="vehiculos">🚛 Asignar Vehículo</button>
                    <button data-section="materiales">💎 Materiales</button>
                    <button data-section="canteras">📍 Canteras</button>
                    <button data-section="proyectos">🏁 Proyectos</button>
                </div>
                <div id="admin-content" class="admin-content"></div>
            </div>`;
            
        document.getElementById('tab-summary').innerHTML = `
            <div class="card">
                <h2>🔎 Filtrar e Imprimir</h2>
                <div class="filter-form">
                    <label for="filtroMes"><strong>Filtrar por Mes:</strong></label><input type="month" id="filtroMes">
                    <span style="border-left: 1px solid var(--color-borde); margin: 0 10px;"></span>
                    <label for="fechaInicio">Desde:</label><input type="date" id="fechaInicio">
                    <label for="fechaFin">Hasta:</label><input type="date" id="fechaFin">
                    <label for="filtroMaterial">Material:</label>
                    <select id="filtroMaterial"><option value="">-- Todos --</option></select>
                    <label for="filtroCantera">Cantera:</label>
                    <select id="filtroCantera"><option value="">-- Todas --</option></select>
                    <label for="filtroProyecto">Proyecto:</label>
                    <select id="filtroProyecto"><option value="">-- Todos --</option></select>
                    <button id="btnFiltrar" class="btn-primary">Filtrar</button>
                    <button id="btnMostrarTodo" class="btn-secondary">Mostrar Todo</button>
                    <button id="btnPrint" class="btn-primary">🖨️ Imprimir</button>
                    <button id="btnExportarCSV" class="btn-success">📊 Exportar a CSV</button>
                </div>
            </div>
            <div class="card">
                <div class="print-only">TRANSPORTE DE MATERIALES PETREOS</div>
                <h2 class="no-print">Historial de Viajes</h2>
                <div style="overflow-x:auto;">
                    <table id="registrosTabla">
                        <thead><tr><th>Item</th><th>Fecha</th><th>Nombres</th><th>Placa</th><th>Material</th><th>Cantera</th><th>Proyecto</th><th>Observaciones</th><th>Volumen</th><th># Viajes</th><th>Vol. Total</th><th class="action-cell">Acciones</th></tr></thead>
                        <tbody id="registrosBody"></tbody>
                        <tfoot id="registrosTfoot"></tfoot>
                    </table>
                </div>
            </div>`;
        document.getElementById('signature-section').innerHTML = `<div class="signature-box"><p class="signature-line">_________________________</p><p>Ing. Jose L. Macas P.</p><p>Residente de Obra</p></div>`;
    };
    
    let registrosFiltrados = [];

    const renderizarRegistros = (registros) => {
        registrosFiltrados = registros; // Guardar los registros actuales para la exportación

        const registrosBody = document.getElementById('registrosBody');
        const registrosTfoot = document.getElementById('registrosTfoot');

        registros.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        registrosBody.innerHTML = '';
        registrosTfoot.innerHTML = '';

        if (registros.length === 0) {
            registrosBody.innerHTML = `<tr><td colspan="12" style="text-align:center; padding: 20px;">No se encontraron registros.</td></tr>`;
            return;
        }
        let totalViajes = 0;
        let totalVolumen = 0;
        registros.forEach((registro, index) => {
            const fila = document.createElement('tr');
            const volumen = parseFloat(registro.volumen) || 0;
            const numViajes = parseInt(registro.numViajes) || 0;
            const volumenTotal = (volumen * numViajes);
            totalViajes += numViajes;
            totalVolumen += volumenTotal;
            fila.innerHTML = `<td>${index + 1}</td><td>${registro.fecha}</td><td>${registro.nombres}</td><td>${registro.placa}</td><td>${registro.material || ''}</td><td>${registro.cantera || ''}</td><td>${registro.proyecto || ''}</td><td>${registro.observaciones || ''}</td><td>${volumen.toFixed(2)}</td><td>${numViajes}</td><td><b>${volumenTotal.toFixed(2)}</b></td><td class="action-cell" style="display: flex; gap: 5px;"><button title="Modificar" class="action-btn edit-btn" data-id="${registro.id}">✏️</button><button title="Borrar" class="action-btn delete-btn" data-id="${registro.id}">🗑️</button></td>`;
            registrosBody.appendChild(fila);
        });
        if (registros.length > 0) {
            const pieDeTabla = document.createElement('tr');
            pieDeTabla.innerHTML = `<td colspan="9" style="text-align: right;"><strong>TOTALES:</strong></td><td><strong>${totalViajes}</strong></td><td><strong>${totalVolumen.toFixed(2)}</strong></td><td class="action-cell"></td>`;
            registrosTfoot.appendChild(pieDeTabla);
        }
    };

    const administrarListaSimple = async (collectionName, formId, inputId, listaId, selectIds, nombreSingular) => {
        const form = document.getElementById(formId);
        const inputEl = document.getElementById(inputId);
        const listaUl = document.getElementById(listaId);
        const editIdInput = form.querySelector('.edit-id');
        const submitBtn = form.querySelector('button[type="submit"]');
        const resetForm = () => { editIdInput.value = ''; inputEl.value = ''; submitBtn.textContent = 'Agregar'; submitBtn.classList.remove('btn-success');};
        const render = async () => {
            const q = query(collection(db, collectionName));
            const snapshot = await getDocs(q);
            const items = [];
            snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
            items.sort((a, b) => a.nombre.localeCompare(b.nombre));
            listaUl.innerHTML = '';
            const selectsToUpdate = Array.from(document.querySelectorAll(selectIds.join(','))).filter(el => el);
            selectsToUpdate.forEach(sel => { 
                const currentValue = sel.value;
                sel.innerHTML = `<option value="">-- Todos --</option>`; 
                items.forEach(item => sel.add(new Option(item.nombre, item.nombre)));
                sel.value = currentValue;
            });
            items.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${item.nombre}</span><div class="actions"><button class="list-action-btn edit-btn" title="Modificar" data-id="${item.id}" data-nombre="${item.nombre}">✏️</button><button class="list-action-btn delete-btn" title="Borrar" data-id="${item.id}">🗑️</button></div>`;
                listaUl.appendChild(li);
            });
        };
        form.addEventListener('submit', async e => {
            e.preventDefault();
            const nuevoValor = inputEl.value.trim();
            const idParaEditar = editIdInput.value;
            if (nuevoValor) {
                if(idParaEditar) { await updateDoc(doc(db, collectionName, idParaEditar), { nombre: nuevoValor }); } 
                else { await addDoc(collection(db, collectionName), { nombre: nuevoValor }); }
                resetForm(); await render();
            }
        });
        listaUl.addEventListener('click', async e => {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            if (target.classList.contains('delete-btn')) {
                if (confirm(`¿Seguro que quieres borrar este ${nombreSingular}?`)) {
                    await deleteDoc(doc(db, collectionName, id));
                    await render();
                }
            } else if (target.classList.contains('edit-btn')) {
                inputEl.value = target.dataset.nombre;
                editIdInput.value = id;
                submitBtn.textContent = 'Guardar';
                submitBtn.classList.add('btn-success');
                inputEl.focus();
            }
        });
        await render();
    };
    
    let choferesVehiculosCache = [];
    const administrarChoferesVehiculos = async () => {
        const form = document.getElementById('choferVehiculoForm');
        const listaUl = document.getElementById('choferesVehiculosLista');
        const editIdInput = form.querySelector('.edit-id');
        const submitBtn = form.querySelector('button[type="submit"]');
        const selectNombreEl = document.getElementById('selectNombreAdmin');
        const nuevaPlacaEl = document.getElementById('nuevaPlaca');
        const nuevoVolumenEl = document.getElementById('nuevoVolumen');

        // Poblar el select de nombres de choferes
        const qNombres = query(collection(db, "nombresDeChoferes"));
        const snapshotNombres = await getDocs(qNombres);
        selectNombreEl.innerHTML = '<option value="">Seleccionar Chofer</option>';
        snapshotNombres.forEach(doc => selectNombreEl.add(new Option(doc.data().nombre, doc.data().nombre)));

        const resetForm = () => { editIdInput.value = ''; form.reset(); submitBtn.textContent = 'Asignar'; submitBtn.classList.remove('btn-success'); };
        const render = async () => {
            const q = query(collection(db, "choferesVehiculos"));
            const snapshot = await getDocs(q);
            const items = [];
            snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
            items.sort((a, b) => a.nombre.localeCompare(b.nombre) || a.placa.localeCompare(b.placa));
            listaUl.innerHTML = '';
            choferesVehiculosCache = items;
            items.forEach(chofer => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${chofer.nombre} - ${chofer.placa} (${chofer.volumen} m³)</span><div class="actions"><button class="list-action-btn edit-btn" title="Modificar" data-id="${chofer.id}">✏️</button><button class="list-action-btn delete-btn" title="Borrar" data-id="${chofer.id}">🗑️</button></div>`;
                listaUl.appendChild(li);
            });
        };
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const idParaEditar = editIdInput.value;
            const data = { nombre: selectNombreEl.value, placa: nuevaPlacaEl.value.trim().toUpperCase(), volumen: parseFloat(nuevoVolumenEl.value) };
            if (!data.nombre || !data.placa || !data.volumen) return alert('Por favor, complete todos los campos.');
            if(idParaEditar) { await updateDoc(doc(db, "choferesVehiculos", idParaEditar), data); } 
            else { await addDoc(collection(db, "choferesVehiculos"), data); }
            resetForm(); await render();
        });
        listaUl.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            if (target.classList.contains('delete-btn')) {
                if (confirm(`¿Seguro que quieres borrar esta asignación?`)) {
                    await deleteDoc(doc(db, "choferesVehiculos", id));
                    await render();
                }
            } else if (target.classList.contains('edit-btn')) {
                const item = choferesVehiculosCache.find(c => c.id === id);
                if(item) {
                    selectNombreEl.value = item.nombre;
                    nuevaPlacaEl.value = item.placa;
                    nuevoVolumenEl.value = item.volumen;
                    editIdInput.value = id;
                    submitBtn.textContent = 'Guardar';
                    submitBtn.classList.add('btn-success');
                }
            }
        });
        await render();
    };

    const inicializarApp = async () => {
        cargarContenidoHTML();

        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth).catch((error) => console.error("Error al cerrar sesión", error)));
        
        const transporteForm = document.getElementById('transporteForm');
        const selectNombres = document.getElementById('selectNombres');
        const selectPlaca = document.getElementById('selectPlaca');
        const volumenInput = document.getElementById('volumen');
        const indiceEdicionInput = document.getElementById('indiceEdicion');
        const formViajeTitulo = document.getElementById('formViajeTitulo');
        const btnSubmitViaje = document.getElementById('btnSubmitViaje');
        
        const adminContent = document.getElementById('admin-content');
        const adminSidebarButtons = document.querySelectorAll('.admin-sidebar button');

        const adminSections = {
            choferes: {
                html: `<div class="card"><h2>👤 Nombres de Choferes</h2><form id="nombreChoferForm"><input type="hidden" class="edit-id"><input type="text" id="nuevoNombreChofer" placeholder="Nombre y Apellido" required><button type="submit" class="btn-primary">Agregar</button></form><ul id="nombresChoferesLista"></ul></div>`,
                loader: () => administrarListaSimple('nombresDeChoferes', 'nombreChoferForm', 'nuevoNombreChofer', 'nombresChoferesLista', ['#selectNombreAdmin'], 'Nombre de Chofer')
            },
            vehiculos: {
                html: `<div class="card"><h2>🚛 Asignar Vehículo</h2><form id="choferVehiculoForm"><input type="hidden" class="edit-id"><select id="selectNombreAdmin" required><option value="">Seleccionar Chofer</option></select><input type="text" id="nuevaPlaca" placeholder="Placa" required><input type="number" id="nuevoVolumen" placeholder="Volumen (m³)" step="0.01" required><button type="submit" class="btn-primary">Asignar</button></form><ul id="choferesVehiculosLista"></ul></div>`,
                loader: administrarChoferesVehiculos
            },
            materiales: {
                html: `<div class="card"><h2>💎 Materiales</h2><form id="materialForm"><input type="hidden" class="edit-id"><input type="text" id="nuevoMaterial" placeholder="Nombre" required><button type="submit" class="btn-primary">Agregar</button></form><ul id="materialesLista"></ul></div>`,
                loader: () => administrarListaSimple('materiales', 'materialForm', 'nuevoMaterial', 'materialesLista', ['#selectMaterial', '#filtroMaterial'], 'Material')
            },
            canteras: {
                html: `<div class="card"><h2>📍 Canteras</h2><form id="canteraForm"><input type="hidden" class="edit-id"><input type="text" id="nuevaCantera" placeholder="Nombre" required><button type="submit" class="btn-primary">Agregar</button></form><ul id="canterasLista"></ul></div>`,
                loader: () => administrarListaSimple('canteras', 'canteraForm', 'nuevaCantera', 'canterasLista', ['#selectCantera', '#filtroCantera'], 'Cantera')
            },
            proyectos: {
                html: `<div class="card"><h2>🏁 Proyectos</h2><form id="proyectoForm"><input type="hidden" class="edit-id"><input type="text" id="nuevoProyecto" placeholder="Nombre" required><button type="submit" class="btn-primary">Agregar</button></form><ul id="proyectosLista"></ul></div>`,
                loader: () => administrarListaSimple('proyectos', 'proyectoForm', 'nuevoProyecto', 'proyectosLista', ['#selectProyecto', '#filtroProyecto'], 'Proyecto')
            }
        };

        const showAdminSection = (sectionName) => {
            if (!adminSections[sectionName]) return;
            adminSidebarButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.section === sectionName));
            adminContent.innerHTML = adminSections[sectionName].html;
            adminSections[sectionName].loader();
        };

        adminSidebarButtons.forEach(button => button.addEventListener('click', () => showAdminSection(button.dataset.section)));
        showAdminSection('choferes');

        const cargarRegistros = async (filtros = []) => {
            let q = query(collection(db, "registros"));
            if (filtros.length > 0) { q = query(collection(db, "registros"), ...filtros); }
            const snapshot = await getDocs(q);
            const registrosData = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            renderizarRegistros(registrosData);
        };
        
        document.querySelectorAll('.tab-button').forEach(tab => tab.addEventListener('click', () => {
            document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab.dataset.tab).classList.add('active');
        }));
        
        document.getElementById('btnPrint').addEventListener('click', () => window.print());
        document.getElementById('btnExportarCSV').addEventListener('click', () => {
            if (registrosFiltrados.length === 0) {
                alert("No hay datos para exportar. Por favor, realiza una búsqueda primero.");
                return;
            }

            const headers = ["Item", "Fecha", "Nombres", "Placa", "Material", "Cantera", "Proyecto", "Observaciones", "Volumen", "# Viajes", "Vol. Total"];
            const csvRows = [headers.join(',')];

            registrosFiltrados.forEach((registro, index) => {
                const vol = parseFloat(registro.volumen) || 0;
                const viajes = parseInt(registro.numViajes) || 0;
                const volTotal = (vol * viajes).toFixed(2);
                
                const values = [
                    index + 1,
                    registro.fecha,
                    registro.nombres,
                    registro.placa,
                    registro.material,
                    registro.cantera,
                    registro.proyecto,
                    `"${(registro.observaciones || '').replace(/"/g, '""')}"`, // Escapar comillas dobles
                    vol.toFixed(2),
                    viajes,
                    volTotal
                ];
                csvRows.push(values.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `reporte_transporte_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        document.getElementById('filtroMes').addEventListener('change', () => {
            const mesSeleccionado = document.getElementById('filtroMes').value;
            if (!mesSeleccionado) {
                document.getElementById('fechaInicio').value = '';
                document.getElementById('fechaFin').value = '';
                return;
            }
            const [year, month] = mesSeleccionado.split('-').map(Number);
            const primerDia = new Date(year, month - 1, 1);
            const ultimoDia = new Date(year, month, 0);
            document.getElementById('fechaInicio').value = primerDia.toISOString().slice(0, 10);
            document.getElementById('fechaFin').value = ultimoDia.toISOString().slice(0, 10);
            document.getElementById('btnFiltrar').click();
        });

        document.getElementById('btnFiltrar').addEventListener('click', () => {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const material = document.getElementById('filtroMaterial').value;
            const cantera = document.getElementById('filtroCantera').value;
            const proyecto = document.getElementById('filtroProyecto').value;
            let filtros = [];
            if (fechaInicio) filtros.push(where("fecha", ">=", fechaInicio));
            if (fechaFin) filtros.push(where("fecha", "<=", fechaFin));
            if (material) filtros.push(where("material", "==", material));
            if (cantera) filtros.push(where("cantera", "==", cantera));
            if (proyecto) filtros.push(where("proyecto", "==", proyecto));
            cargarRegistros(filtros);
        });

        document.getElementById('btnMostrarTodo').addEventListener('click', () => {
            document.getElementById('filtroMes').value = '';
            document.getElementById('fechaInicio').value = '';
            document.getElementById('fechaFin').value = '';
            document.getElementById('filtroMaterial').selectedIndex = 0;
            document.getElementById('filtroCantera').selectedIndex = 0;
            document.getElementById('filtroProyecto').selectedIndex = 0;
            cargarRegistros();
        });

        selectNombres.addEventListener('change', async () => {
            const nombreSeleccionado = selectNombres.value;
            selectPlaca.innerHTML = '<option value="">2. Seleccionar Placa</option>';
            volumenInput.value = '';
            
            const q = query(collection(db, "choferesVehiculos"), where("nombre", "==", nombreSeleccionado));
            const snapshot = await getDocs(q);
            const vehiculosDelChofer = [];
            snapshot.forEach(doc => vehiculosDelChofer.push(doc.data()));

            if (nombreSeleccionado) {
                vehiculosDelChofer.forEach(v => {
                    const option = new Option(`${v.placa} (${v.volumen} m³)`, v.placa);
                    option.dataset.volumen = v.volumen;
                    selectPlaca.add(option);
                });
                selectPlaca.disabled = false;
            } else { 
                selectPlaca.disabled = true; 
            }
        });
        
        const qNombres = query(collection(db, "nombresDeChoferes"));
        const snapshotNombres = await getDocs(qNombres);
        snapshotNombres.forEach(doc => selectNombres.add(new Option(doc.data().nombre, doc.data().nombre)));
        
        const poblarSelects = async (collectionName, selectId) => {
            const selectEl = document.getElementById(selectId);
            const q = query(collection(db, collectionName));
            const snapshot = await getDocs(q);
            snapshot.forEach(doc => selectEl.add(new Option(doc.data().nombre, doc.data().nombre)));
        };
        poblarSelects('materiales', 'selectMaterial');
        poblarSelects('canteras', 'selectCantera');
        poblarSelects('proyectos', 'selectProyecto');
        poblarSelects('materiales', 'filtroMaterial');
        poblarSelects('canteras', 'filtroCantera');
        poblarSelects('proyectos', 'filtroProyecto');

        selectPlaca.addEventListener('change', () => {
            const selectedOption = selectPlaca.options[selectPlaca.selectedIndex];
            volumenInput.value = selectedOption.dataset.volumen || '';
        });

        const cancelarEdicion = () => {
            formViajeTitulo.textContent = '🚚 Nuevo Registro de Viaje';
            indiceEdicionInput.value = '';
            transporteForm.reset();
            selectPlaca.innerHTML = '<option value="">2. Seleccionar Placa</option>';
            selectPlaca.disabled = true;
            btnSubmitViaje.textContent = 'Agregar Registro';
            btnSubmitViaje.classList.replace('btn-success', 'btn-primary');
            document.getElementById('btnCancelarEdicion').style.display = 'none';
        };
        document.getElementById('btnCancelarEdicion').addEventListener('click', cancelarEdicion);

        document.getElementById('registrosBody').addEventListener('click', async e => {
            const target = e.target.closest('button');
            if (!target) return;
            const docId = target.dataset.id;
            if (target.classList.contains('delete-btn')) {
                if (confirm(`¿Seguro que quieres borrar este viaje?`)) {
                    await deleteDoc(doc(db, "registros", docId));
                    cargarRegistros();
                }
            } else if (target.classList.contains('edit-btn')) {
                const docSnap = await getDoc(doc(db, "registros", docId));
                if (docSnap.exists()) {
                    const registroAEditar = docSnap.data();
                    document.querySelector('.tab-button[data-tab="tab-registro"]').click();
                    formViajeTitulo.textContent = `✍️ Modificando Viaje`;
                    indiceEdicionInput.value = docId;
                    selectNombres.value = registroAEditar.nombres;
                    selectNombres.dispatchEvent(new Event('change'));
                    setTimeout(() => {
                        selectPlaca.value = registroAEditar.placa;
                        selectPlaca.dispatchEvent(new Event('change'));
                        document.getElementById('fecha').value = registroAEditar.fecha;
                        document.getElementById('selectMaterial').value = registroAEditar.material;
                        document.getElementById('selectCantera').value = registroAEditar.cantera;
                        document.getElementById('selectProyecto').value = registroAEditar.proyecto;
                        document.getElementById('numViajes').value = registroAEditar.numViajes;
                        document.getElementById('observaciones').value = registroAEditar.observaciones || '';
                    }, 200);
                    btnSubmitViaje.textContent = 'Guardar Cambios';
                    btnSubmitViaje.classList.replace('btn-primary', 'btn-success');
                    document.getElementById('btnCancelarEdicion').style.display = 'block';
                    window.scrollTo(0, 0);
                }
            }
        });

        transporteForm.addEventListener('submit', async e => {
            e.preventDefault();
            const btn = btnSubmitViaje;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Guardando...';
            try {
                const idParaEditar = indiceEdicionInput.value;
                const registro = {
                    fecha: document.getElementById('fecha').value,
                    nombres: selectNombres.value,
                    placa: selectPlaca.value,
                    material: document.getElementById('selectMaterial').value,
                    volumen: volumenInput.value,
                    numViajes: document.getElementById('numViajes').value,
                    cantera: document.getElementById('selectCantera').value,
                    proyecto: document.getElementById('selectProyecto').value,
                    observaciones: document.getElementById('observaciones').value
                };
                if (!registro.nombres || !registro.placa || !registro.material || !registro.fecha) {
                    alert('Por favor, complete todos los campos requeridos.');
                    return;
                }
                if (idParaEditar) { await updateDoc(doc(db, "registros", idParaEditar), registro); } 
                else { await addDoc(collection(db, "registros"), registro); }
                cargarRegistros();
                cancelarEdicion();
            } catch (error) {
                console.error("Error al guardar el registro:", error);
                alert("Hubo un error al guardar el registro.");
            } finally {
                btn.disabled = false;
                if (!indiceEdicionInput.value) {
                    btn.textContent = 'Agregar Registro';
                } else {
                    btn.textContent = 'Guardar Cambios';
                }
            }
        });
        
        await cargarRegistros();
    };
</script>
</body>
</html>